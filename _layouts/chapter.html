<!DOCTYPE html>
<html lang="zh-TW" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ page.title }} | 互動溫習平台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; line-height: 1.6; }
        
        /* 模擬錯誤彈窗動畫 */
        .shake { animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        
        /* 狀態標籤 */
        .status-badge { transition: all 0.3s; }
    </style>
    <script>
        tailwind.config = { theme: { extend: { colors: { brand: { 500: '#3b82f6', 600: '#2563eb' } } } } }
    </script>
</head>

<body class="bg-slate-50 text-slate-800">

    {% assign data = site.data[page.data_source] %}

    <nav class="fixed top-0 w-full bg-white/90 backdrop-blur border-b border-slate-200 z-50 h-14 flex items-center">
        <div class="container mx-auto px-4 max-w-5xl flex justify-between">
            <a href="{{ site.baseurl }}/" class="flex items-center text-sm font-bold text-slate-600 hover:text-brand-600">
                <i class="ri-arrow-left-line mr-1"></i> 目錄
            </a>
            <div class="font-bold text-slate-800">{{ page.chapter_id }} {{ page.title }}</div>
        </div>
    </nav>

    <main class="container mx-auto px-4 max-w-3xl pt-24 pb-32">

        <header class="mb-10 text-center">
            <h1 class="text-3xl font-bold text-slate-900 mb-4">{{ page.title }}</h1>
            <p class="text-slate-500">{{ page.description }}</p>
        </header>

        {% if data.key_points %}
        <section class="grid gap-4 md:grid-cols-3 mb-12">
            {% for point in data.key_points %}
            <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                <div class="text-{{ point.color }}-500 text-2xl mb-2"><i class="{{ point.icon }}"></i></div>
                <h3 class="font-bold text-slate-900">{{ point.title }}</h3>
                <p class="text-xs text-slate-500 mt-1">{{ point.desc }}</p>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        {% if data.interactive_demo %}
        <section id="demo" class="mb-16 scroll-mt-20">
            <div class="bg-white rounded-2xl shadow-lg border border-slate-200 overflow-hidden">
                <div class="bg-slate-800 text-white p-6">
                    <h2 class="text-xl font-bold flex items-center gap-2">
                        <i class="ri-flask-line"></i> {{ data.interactive_demo.title }}
                    </h2>
                    <p class="text-slate-300 text-sm mt-2">{{ data.interactive_demo.intro }}</p>
                </div>
                
                <div class="p-6 md:p-8 space-y-8">
                    {% for field in data.interactive_demo.fields %}
                    <div class="field-group">
                        <div class="flex justify-between mb-2">
                            <label class="font-bold text-slate-700">{{ field.label }}</label>
                            <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded border border-slate-200">
                                監控中: {{ field.check_type }}
                            </span>
                        </div>
                        
                        <div class="relative">
                            <input type="{{ field.type | default: 'text' }}" 
                                   id="{{ field.id }}" 
                                   placeholder="{{ field.placeholder }}"
                                   class="w-full p-3 rounded-lg border-2 border-slate-200 focus:border-brand-500 focus:outline-none transition-colors text-slate-800"
                                   oninput="validateField(this, '{{ field.validation_rule }}', {{ field.min | default: 'null' }}, {{ field.max | default: 'null' }})">
                            
                            <div class="absolute right-3 top-3 text-xl hidden" id="{{ field.id }}_icon"></div>
                        </div>
                        
                        <div class="mt-2 text-sm min-h-[20px]">
                            <p id="{{ field.id }}_msg" class="text-slate-500 flex items-center gap-1">
                                <i class="ri-information-line"></i> {{ field.hint }}
                            </p>
                        </div>
                    </div>
                    {% endfor %}

                    <div class="bg-blue-50 border border-blue-100 rounded-lg p-4 text-sm text-blue-800">
                        <i class="ri-lightbulb-line mr-1"></i> 
                        <strong>小提示：</strong> 只有當所有「檢驗」通過後，數據才會被存入系統。這就是 GIGO 原則的防線！
                    </div>
                </div>
            </div>
        </section>
        {% endif %}

        {% if data.timeline_stages %}
        <section class="mb-16">
            <h2 class="text-2xl font-bold text-slate-900 mb-6">重點知識架構</h2>
            <div class="space-y-4">
                {% for stage in data.timeline_stages %}
                <div class="flex gap-4 items-start p-4 bg-white rounded-lg border border-slate-100 shadow-sm">
                    <div class="w-8 h-8 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center font-bold shrink-0">
                        {{ forloop.index }}
                    </div>
                    <div>
                        <h3 class="font-bold text-slate-800">{{ stage.title }}</h3>
                        <p class="text-sm text-slate-600">{{ stage.desc }}</p>
                        {% if stage.extra %}<p class="text-xs text-slate-400 mt-1">{{ stage.extra }}</p>{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>
        {% endif %}

        {% if data.quiz_questions %}
        <section id="quiz">
            <div class="bg-white rounded-2xl shadow-md border border-slate-200 p-8">
                <div class="flex justify-between items-end mb-6 border-b border-slate-100 pb-4">
                    <h2 class="text-2xl font-bold text-slate-900">課後測驗</h2>
                    <div class="text-right">
                        <span class="text-3xl font-bold text-brand-600" id="scoreDisplay">0</span>
                        <span class="text-slate-400">/ {{ data.quiz_questions | size }}</span>
                    </div>
                </div>
                <div id="quiz-container"></div>
            </div>
        </section>
        {% endif %}

    </main>

    <script>
        // --- 核心邏輯：互動實驗室 (Real-time Validation) ---
        function validateField(input, rule, min, max) {
            const val = input.value;
            const id = input.id;
            const msgBox = document.getElementById(id + "_msg");
            const iconBox = document.getElementById(id + "_icon");
            
            let isValid = false;
            let errorMsg = "";
            let successMsg = "格式正確！✅";

            // 如果是空的 (除了 Presence Check 外，其他空值通常不報錯，讓用戶有機會刪除)
            if (val === "" && rule !== 'presence') {
                resetField(input, id);
                return;
            }

            // 規則判斷引擎
            switch(rule) {
                case 'range':
                    if (!isNaN(val) && val >= min && val <= max) {
                        isValid = true;
                    } else {
                        errorMsg = `❌ 錯誤：數值必須在 ${min} 至 ${max} 之間！`;
                    }
                    break;
                
                case 'phone':
                    // 類型檢查(數字) + 長度檢查(8位)
                    if (/^\d+$/.test(val)) {
                        if (val.length === 8) isValid = true;
                        else errorMsg = `❌ 長度錯誤：電話號碼需要 8 個數字 (目前 ${val.length} 個)`;
                    } else {
                        errorMsg = "❌ 類型錯誤：請只輸入數字！";
                    }
                    break;

                case 'format_sid':
                    // 1個英文 + 6個數字
                    if (/^[A-Za-z]\d{6}$/.test(val)) {
                        isValid = true;
                    } else {
                        errorMsg = "❌ 格式錯誤：需為 1 個字母開頭，後接 6 個數字 (例: A123456)";
                    }
                    break;

                case 'presence':
                    if (val.trim().length > 0) isValid = true;
                    else errorMsg = "❌ 錯誤：此欄位為必填！";
                    break;

                case 'password_1':
                    if (val.length >= 4) isValid = true;
                    else errorMsg = "⚠️ 密碼太短了";
                    // 觸發確認密碼的檢查
                    const confirmInput = document.getElementById('pwd_confirm');
                    if(confirmInput.value) validateField(confirmInput, 'password_2');
                    break;

                case 'password_2':
                    const originalPwd = document.getElementById('pwd').value;
                    if (val === originalPwd && val !== "") {
                        isValid = true;
                        successMsg = "✅ 密碼核實一致！";
                    } else {
                        errorMsg = "❌ 核實失敗：兩次輸入的密碼不相同！";
                    }
                    break;
            }

            // 更新 UI 狀態
            updateUI(input, id, isValid, isValid ? successMsg : errorMsg);
        }

        function updateUI(input, id, isValid, msg) {
            const msgBox = document.getElementById(id + "_msg");
            const iconBox = document.getElementById(id + "_icon");
            
            input.classList.remove('border-slate-200', 'border-red-500', 'border-green-500');
            input.classList.add(isValid ? 'border-green-500' : 'border-red-500');
            
            if(!isValid) {
                input.parentElement.classList.add('shake');
                setTimeout(() => input.parentElement.classList.remove('shake'), 500);
            }

            msgBox.innerHTML = `<span class="${isValid ? 'text-green-600' : 'text-red-500'} font-bold">${msg}</span>`;
            
            iconBox.innerHTML = isValid ? '<i class="ri-checkbox-circle-fill text-green-500"></i>' : '<i class="ri-close-circle-fill text-red-500"></i>';
            iconBox.classList.remove('hidden');
        }

        function resetField(input, id) {
            input.classList.remove('border-red-500', 'border-green-500');
            input.classList.add('border-slate-200');
            document.getElementById(id + "_icon").classList.add('hidden');
            // 恢復原始 Hint
            // (簡化起見，這裡不清空 Hint，或需要從 Data 屬性重新讀取，這裡先留空)
            document.getElementById(id + "_msg").innerHTML = '<span class="text-slate-400">等待輸入...</span>';
        }

        // --- 測驗邏輯 (保留之前的) ---
        const quizData = {{ data.quiz_questions | jsonify }} || [];
        let qIndex = 0, score = 0;
        if(quizData.length > 0) loadQuiz();

        function loadQuiz() {
            if(qIndex >= quizData.length) {
                document.getElementById('quiz-container').innerHTML = `<div class="text-center py-8"><h3 class="text-xl font-bold mb-2">完成！</h3><p>得分: ${score}</p><button onclick="qIndex=0;score=0;document.getElementById('scoreDisplay').innerText='0';loadQuiz()" class="mt-4 text-brand-600 underline">重試</button></div>`;
                return;
            }
            const q = quizData[qIndex];
            document.getElementById('quiz-container').innerHTML = `
                <div class="fade-in">
                    <h4 class="font-bold text-lg mb-6">${qIndex+1}. ${q.question}</h4>
                    <div class="space-y-3">
                        ${q.options.map((opt,i)=>`<button onclick="checkQuiz(${i})" class="w-full text-left p-3 rounded border hover:bg-slate-50 flex gap-3"><div class="w-6 h-6 rounded-full border flex items-center justify-center text-xs">${String.fromCharCode(65+i)}</div>${opt}</button>`).join('')}
                    </div>
                    <div id="explanation" class="hidden mt-6 p-4 bg-blue-50 text-slate-700 text-sm rounded"></div>
                    <button id="nextBtn" onclick="nextQ()" class="hidden mt-4 text-brand-600 font-bold flex items-center">下一題 <i class="ri-arrow-right-line ml-1"></i></button>
                </div>`;
        }
        function checkQuiz(idx) {
            const q = quizData[qIndex];
            const isCorrect = idx === q.correct;
            if(isCorrect) { score++; document.getElementById('scoreDisplay').innerText = score; }
            document.getElementById('explanation').innerHTML = `<strong>解析：</strong>${q.explanation}`;
            document.getElementById('explanation').classList.remove('hidden');
            document.getElementById('nextBtn').classList.remove('hidden');
            document.querySelectorAll('#quiz-container button:not(#nextBtn)').forEach((btn, i) => {
                btn.disabled = true;
                if(i === q.correct) btn.classList.add('bg-green-100', 'border-green-500');
                else if(i === idx && !isCorrect) btn.classList.add('bg-red-100', 'border-red-500');
            });
        }
        function nextQ() { qIndex++; loadQuiz(); }
    </script>
</body>
</html>
